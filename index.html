<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Bulk Image Metadata Cleaner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .top-actions {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
        }

        .top-actions.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .top-actions-left {
            color: white;
        }

        .top-actions-left h3 {
            margin-bottom: 5px;
            font-size: 1.3em;
        }

        .top-actions-left p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .top-actions-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 30px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .upload-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .upload-btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .control-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-group input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 50px;
            font-weight: 600;
            color: #667eea;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-large {
            padding: 15px 40px;
            font-size: 16px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .image-card {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .image-card-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #e9ecef;
        }

        .image-card-body {
            padding: 15px;
        }

        .image-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .image-card-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .image-card-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-original {
            background: #fff3cd;
            color: #856404;
        }

        .status-cleaned {
            background: #d4edda;
            color: #155724;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .image-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            flex: 1;
        }

        .metadata-preview {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
        }

        .metadata-item-small {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }

        .metadata-key-small {
            font-weight: 600;
            color: #667eea;
        }

        .metadata-value-small {
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            border-radius: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .hidden {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 13px;
            color: #0d47a1;
        }

        .feature-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #333;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-side {
            text-align: center;
        }

        .comparison-side h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .comparison-side img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .comparison-view {
                grid-template-columns: 1fr;
            }
            
            .top-actions.show {
                flex-direction: column;
            }
            
            .top-actions-right {
                width: 100%;
            }
            
            .top-actions-right .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 Advanced Image Metadata Cleaner</h1>
        <p class="subtitle">Professional bulk image processing with complete metadata control</p>

        <div id="alert" class="alert"></div>

        <!-- Top Actions Bar -->
        <div id="topActions" class="top-actions">
            <div class="top-actions-left">
                <h3>📦 <span id="topTotalImages">0</span> Images Loaded</h3>
                <p><span id="topCleanedImages">0</span> cleaned • <span id="topTotalSize">0 MB</span> total</p>
            </div>
            <div class="top-actions-right">
                <button class="btn btn-danger btn-large" id="topCleanAllBtn">
                    🗑️ Clean All
                </button>
                <button class="btn btn-success btn-large" id="topDownloadAllBtn">
                    ⬇️ Download All as ZIP
                </button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">📁</div>
            <h3>Upload Your Images</h3>
            <p style="margin: 10px 0; color: #666;">Drag and drop files/folders or click to select</p>
            
            <div class="upload-buttons">
                <input type="file" id="fileInput" accept="image/*" multiple>
                <label for="fileInput" class="upload-btn">📄 Select Multiple Files</label>
                
                <input type="file" id="folderInput" webkitdirectory directory multiple>
                <label for="folderInput" class="upload-btn upload-btn-secondary">📂 Select Folder</label>
            </div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-value" id="totalImages">0</div>
                    <div class="stat-label">Total Images</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cleanedImages">0</div>
                    <div class="stat-label">Cleaned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSize">0 MB</div>
                    <div class="stat-label">Total Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="savedSize">0 KB</div>
                    <div class="stat-label">Size Saved</div>
                </div>
            </div>

            <div class="control-panel">
                <div class="control-tabs">
                    <button class="tab-btn active" data-tab="metadata">📝 Metadata Settings</button>
                    <button class="tab-btn" data-tab="image">🖼️ Image Processing</button>
                    <button class="tab-btn" data-tab="export">💾 Export Options</button>
                    <button class="tab-btn" data-tab="batch">⚙️ Batch Actions</button>
                </div>

                <!-- Metadata Settings Tab -->
                <div id="metadataTab" class="tab-content active">
                    <div class="settings-grid">
                        <div class="input-group">
                            <label for="authorInput">👤 Author</label>
                            <input type="text" id="authorInput" placeholder="Enter author name">
                        </div>
                        <div class="input-group">
                            <label for="copyrightInput">© Copyright</label>
                            <input type="text" id="copyrightInput" placeholder="© 2024 Your Name">
                        </div>
                        <div class="input-group">
                            <label for="titleInput">📌 Title</label>
                            <input type="text" id="titleInput" placeholder="Enter image title">
                        </div>
                        <div class="input-group">
                            <label for="keywordsInput">🏷️ Keywords</label>
                            <input type="text" id="keywordsInput" placeholder="nature, landscape, photo">
                        </div>
                        <div class="input-group">
                            <label for="descriptionInput">📄 Description</label>
                            <textarea id="descriptionInput" placeholder="Enter image description"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="creditInput">💳 Credit/Source</label>
                            <input type="text" id="creditInput" placeholder="Photo credit">
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong>ℹ️ Metadata Options:</strong> Leave all fields empty for complete metadata wipe. 
                        Fill in only the fields you want to keep. All other metadata will be removed.
                    </div>
                </div>

                <!-- Image Processing Tab -->
                <div id="imageTab" class="tab-content">
                    <div class="settings-grid">
                        <div class="input-group">
                            <label>📐 Resize Images</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="resizeEnabled">
                                <label for="resizeEnabled">Enable Resizing</label>
                            </div>
                            <select id="resizeMode" disabled>
                                <option value="percent">Percentage</option>
                                <option value="width">Fixed Width</option>
                                <option value="height">Fixed Height</option>
                                <option value="max">Max Dimension</option>
                            </select>
                            <input type="number" id="resizeValue" placeholder="Value" disabled>
                        </div>

                        <div class="input-group">
                            <label>🎨 Image Quality</label>
                            <div class="range-group">
                                <input type="range" id="qualitySlider" min="1" max="100" value="95">
                                <span class="range-value" id="qualityValue">95%</span>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>🔄 Rotation</label>
                            <select id="rotationSelect">
                                <option value="0">No Rotation</option>
                                <option value="90">90° Clockwise</option>
                                <option value="180">180°</option>
                                <option value="270">270° Clockwise</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>✨ Filters</label>
                            <select id="filterSelect">
                                <option value="none">None</option>
                                <option value="grayscale">Grayscale</option>
                                <option value="sepia">Sepia</option>
                                <option value="invert">Invert</option>
                                <option value="brightness">Increase Brightness</option>
                                <option value="contrast">Increase Contrast</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Export Options Tab -->
                <div id="exportTab" class="tab-content">
                    <div class="settings-grid">
                        <div class="input-group">
                            <label>📦 Output Format</label>
                            <select id="outputFormat">
                                <option value="png">PNG (Lossless)</option>
                                <option value="jpeg">JPEG (Compressed)</option>
                                <option value="webp">WebP (Modern)</option>
                                <option value="original">Keep Original</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>📝 Filename Pattern</label>
                            <input type="text" id="filenamePattern" placeholder="e.g., clean_{original}_{date}">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Use: {original}, {author}, {date}, {index}
                            </small>
                        </div>

                        <div class="input-group">
                            <label>🗂️ Folder Structure</label>
                            <select id="folderStructure">
                                <option value="flat">Single Folder</option>
                                <option value="original">Keep Original Structure</option>
                                <option value="bydate">Organize by Date</option>
                                <option value="bysize">Organize by Size</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>📋 Export Options</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="exportMetadataFile">
                                <label for="exportMetadataFile">Include metadata report (CSV)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="exportReadme" checked>
                                <label for="exportReadme">Include README file</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Batch Actions Tab -->
                <div id="batchTab" class="tab-content">
                    <div class="bulk-actions">
                        <button class="btn btn-danger" id="cleanAllBtn">
                            🗑️ Clean All Metadata
                        </button>
                        <button class="btn btn-success" id="downloadAllBtn">
                            ⬇️ Download All (ZIP)
                        </button>
                        <button class="btn btn-primary" id="applySettingsBtn">
                            ✨ Apply Settings to All
                        </button>
                        <button class="btn btn-warning" id="resetAllBtn">
                            🔄 Reset All to Original
                        </button>
                        <button class="btn btn-info" id="selectAllBtn">
                            ✓ Select All
                        </button>
                        <button class="btn btn-info" id="deselectAllBtn">
                            ✗ Deselect All
                        </button>
                    </div>
                    
                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>

                    <div class="info-box" style="margin-top: 20px;">
                        <strong>💡 Batch Tips:</strong><br>
                        • Use "Clean All" to remove all metadata from all images<br>
                        • Use "Apply Settings" to add your custom metadata to all images<br>
                        • Select specific images to process only those<br>
                        • Download creates a ZIP with all processed images
                    </div>
                </div>
            </div>

            <div id="imagesGrid" class="images-grid"></div>

            <div id="emptyState" class="empty-state hidden">
                <div class="empty-state-icon">🖼️</div>
                <h3>No images loaded</h3>
                <p>Upload some images to get started</p>
            </div>
        </div>
    </div>

    <!-- Metadata Viewer Modal -->
    <div id="metadataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 Detailed Metadata</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalMetadataContent"></div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔍 Before/After Comparison</h2>
                <button class="close-modal" onclick="closeComparisonModal()">&times;</button>
            </div>
            <div class="comparison-view" id="comparisonContent"></div>
        </div>
    </div>

    <!-- JSZip Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // State management
        let images = [];
        let imageIdCounter = 0;

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const uploadSection = document.getElementById('uploadSection');
        const mainContent = document.getElementById('mainContent');
        const topActions = document.getElementById('topActions');
        const imagesGrid = document.getElementById('imagesGrid');
        const emptyState = document.getElementById('emptyState');
        const alertBox = document.getElementById('alert');

        // Stats elements
        const totalImagesEl = document.getElementById('totalImages');
        const cleanedImagesEl = document.getElementById('cleanedImages');
        const totalSizeEl = document.getElementById('totalSize');
        const savedSizeEl = document.getElementById('savedSize');
        const topTotalImagesEl = document.getElementById('topTotalImages');
        const topCleanedImagesEl = document.getElementById('topCleanedImages');
        const topTotalSizeEl = document.getElementById('topTotalSize');

        // Control elements
        const authorInput = document.getElementById('authorInput');
        const copyrightInput = document.getElementById('copyrightInput');
        const titleInput = document.getElementById('titleInput');
        const keywordsInput = document.getElementById('keywordsInput');
        const descriptionInput = document.getElementById('descriptionInput');
        const creditInput = document.getElementById('creditInput');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const resizeEnabled = document.getElementById('resizeEnabled');
        const resizeMode = document.getElementById('resizeMode');
        const resizeValue = document.getElementById('resizeValue');
        const rotationSelect = document.getElementById('rotationSelect');
        const filterSelect = document.getElementById('filterSelect');
        const outputFormat = document.getElementById('outputFormat');
        const filenamePattern = document.getElementById('filenamePattern');

        // Button elements
        const cleanAllBtn = document.getElementById('cleanAllBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const topCleanAllBtn = document.getElementById('topCleanAllBtn');
        const topDownloadAllBtn = document.getElementById('topDownloadAllBtn');
        const applySettingsBtn = document.getElementById('applySettingsBtn');
        const resetAllBtn = document.getElementById('resetAllBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');

        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // Event listeners
        fileInput.addEventListener('change', handleFileSelect);
        folderInput.addEventListener('change', handleFileSelect);
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('dragleave', handleDragLeave);
        uploadSection.addEventListener('drop', handleDrop);
        
        cleanAllBtn.addEventListener('click', cleanAllImages);
        downloadAllBtn.addEventListener('click', downloadAllImages);
        topCleanAllBtn.addEventListener('click', cleanAllImages);
        topDownloadAllBtn.addEventListener('click', downloadAllImages);
        applySettingsBtn.addEventListener('click', applySettingsToAll);
        resetAllBtn.addEventListener('click', resetAllImages);
        selectAllBtn.addEventListener('click', selectAll);
        deselectAllBtn.addEventListener('click', deselectAll);

        qualitySlider.addEventListener('input', (e) => {
            qualityValue.textContent = e.target.value + '%';
        });

        resizeEnabled.addEventListener('change', (e) => {
            resizeMode.disabled = !e.target.checked;
            resizeValue.disabled = !e.target.checked;
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                addImages(files);
            } else {
                showAlert('No valid image files found', 'warning');
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const items = Array.from(e.dataTransfer.items);
            const files = [];

            const promises = items.map(item => {
                return new Promise((resolve) => {
                    if (item.kind === 'file') {
                        const entry = item.webkitGetAsEntry();
                        if (entry) {
                            if (entry.isFile) {
                                entry.file(file => {
                                    if (file.type.startsWith('image/')) {
                                        files.push(file);
                                    }
                                    resolve();
                                });
                            } else if (entry.isDirectory) {
                                readDirectory(entry, files).then(resolve);
                            }
                        } else {
                            const file = item.getAsFile();
                            if (file && file.type.startsWith('image/')) {
                                files.push(file);
                            }
                            resolve();
                        }
                    } else {
                        resolve();
                    }
                });
            });

            Promise.all(promises).then(() => {
                if (files.length > 0) {
                    addImages(files);
                } else {
                    showAlert('No valid image files found', 'warning');
                }
            });
        }

        function readDirectory(directory, files) {
            return new Promise((resolve) => {
                const reader = directory.createReader();
                const readEntries = () => {
                    reader.readEntries(entries => {
                        if (entries.length === 0) {
                            resolve();
                            return;
                        }

                        const promises = entries.map(entry => {
                            return new Promise((resolveEntry) => {
                                if (entry.isFile) {
                                    entry.file(file => {
                                        if (file.type.startsWith('image/')) {
                                            files.push(file);
                                        }
                                        resolveEntry();
                                    });
                                } else if (entry.isDirectory) {
                                    readDirectory(entry, files).then(resolveEntry);
                                }
                            });
                        });

                        Promise.all(promises).then(readEntries);
                    });
                };
                readEntries();
            });
        }

        function addImages(files) {
            files.forEach(file => {
                const id = imageIdCounter++;
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imageData = {
                        id: id,
                        file: file,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        originalDataUrl: e.target.result,
                        cleanedDataUrl: null,
                        cleanedBlob: null,
                        status: 'original',
                        metadata: {},
                        selected: true,
                        settings: getDefaultSettings()
                    };

                    images.push(imageData);
                    extractMetadata(imageData).then(() => {
                        renderImage(imageData);
                        updateStats();
                    });
                    
                    mainContent.classList.remove('hidden');
                    topActions.classList.add('show');
                    emptyState.classList.add('hidden');
                };
                
                reader.readAsDataURL(file);
            });

            showAlert(`✅ ${files.length} image(s) loaded successfully!`, 'success');
        }

        function getDefaultSettings() {
            return {
                author: '',
                copyright: '',
                title: '',
                keywords: '',
                description: '',
                credit: '',
                quality: 95,
                resize: false,
                resizeMode: 'percent',
                resizeValue: 100,
                rotation: 0,
                filter: 'none',
                format: 'png'
            };
        }

        function extractMetadata(imageData) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const view = new DataView(arrayBuffer);
                    
                    imageData.metadata = {
                        'File Name': imageData.name,
                        'File Size': formatBytes(imageData.size),
                        'File Type': imageData.type
                    };

                    // Check for JPEG
                    if (view.getUint16(0, false) === 0xFFD8) {
                        parseJPEGMetadata(view, imageData.metadata);
                    } 
                    // Check for PNG
                    else if (view.getUint32(0, false) === 0x89504E47) {
                        parsePNGMetadata(view, imageData.metadata);
                    }

                    // Get dimensions
                    const img = new Image();
                    img.onload = function() {
                        imageData.metadata['Dimensions'] = `${img.width} × ${img.height}`;
                        imageData.metadata['Aspect Ratio'] = (img.width / img.height).toFixed(3);
                        imageData.width = img.width;
                        imageData.height = img.height;
                        resolve();
                    };
                    img.src = imageData.originalDataUrl;
                };
                reader.readAsArrayBuffer(imageData.file);
            });
        }

        function parseJPEGMetadata(view, metadata) {
            let offset = 2;
            while (offset < view.byteLength - 4) {
                const marker = view.getUint16(offset, false);
                if (marker < 0xFF00) break;
                const length = view.getUint16(offset + 2, false);
                
                if (marker === 0xFFE0) metadata['JFIF'] = 'Present';
                if (marker === 0xFFE1) metadata['EXIF Data'] = `Present (${formatBytes(length)})`;
                if (marker === 0xFFE2) metadata['ICC Profile'] = 'Present';
                if (marker === 0xFFED) metadata['Photoshop Data'] = 'Present';
                if (marker === 0xFFFE) metadata['Comment'] = 'Present';
                
                offset += 2 + length;
            }
        }

        function parsePNGMetadata(view, metadata) {
            let offset = 8;
            while (offset < view.byteLength - 8) {
                const length = view.getUint32(offset, false);
                const type = String.fromCharCode(
                    view.getUint8(offset + 4),
                    view.getUint8(offset + 5),
                    view.getUint8(offset + 6),
                    view.getUint8(offset + 7)
                );
                
                if (type === 'tEXt') metadata['PNG Text'] = 'Present';
                if (type === 'iTXt') metadata['PNG International Text'] = 'Present';
                if (type === 'pHYs') metadata['Physical Dimensions'] = 'Present';
                if (type === 'tIME') metadata['Modification Time'] = 'Present';
                if (type === 'eXIf') metadata['EXIF Data'] = 'Present';
                if (type === 'IEND') break;
                
                offset += 12 + length;
            }
        }

        function renderImage(imageData) {
            const card = document.createElement('div');
            card.className = 'image-card';
            card.id = `image-${imageData.id}`;

            const metadataCount = Object.keys(imageData.metadata).length;
            const metadataHtml = Object.entries(imageData.metadata).slice(0, 3).map(([key, value]) => `
                <div class="metadata-item-small">
                    <span class="metadata-key-small">${key}</span>
                    <span class="metadata-value-small">${value}</span>
                </div>
            `).join('');

            card.innerHTML = `
                <img class="image-card-preview" src="${imageData.originalDataUrl}" alt="${imageData.name}">
                <div class="image-card-body">
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="select-${imageData.id}" ${imageData.selected ? 'checked' : ''} 
                               onchange="toggleImageSelection(${imageData.id})">
                        <label for="select-${imageData.id}" class="image-card-title" title="${imageData.name}">
                            ${imageData.name}
                        </label>
                    </div>
                    <div class="image-card-info">
                        ${formatBytes(imageData.size)} • ${imageData.type.split('/')[1].toUpperCase()}
                    </div>
                    <div class="image-card-info">
                        ${imageData.width} × ${imageData.height} px • ${metadataCount} metadata fields
                    </div>
                    <span class="image-card-status status-${imageData.status}" id="status-${imageData.id}">
                        ${imageData.status === 'original' ? '📋 Original' : '✓ Cleaned'}
                    </span>
                    <div class="metadata-preview">
                        ${metadataHtml}
                    </div>
                    <div class="image-card-actions">
                        <button class="btn btn-danger btn-small" onclick="cleanSingleImage(${imageData.id})">
                            🗑️ Clean
                        </button>
                        <button class="btn btn-info btn-small" onclick="viewMetadata(${imageData.id})">
                            📋 View
                        </button>
                        <button class="btn btn-primary btn-small" onclick="compareImage(${imageData.id})">
                            🔍 Compare
                        </button>
                        <button class="btn btn-success btn-small" onclick="downloadSingleImage(${imageData.id})">
                            ⬇️
                        </button>
                    </div>
                </div>
            `;

            imagesGrid.appendChild(card);
        }

        function toggleImageSelection(id) {
            const imageData = images.find(img => img.id === id);
            if (imageData) {
                imageData.selected = !imageData.selected;
            }
        }

        function selectAll() {
            images.forEach(img => {
                img.selected = true;
                const checkbox = document.getElementById(`select-${img.id}`);
                if (checkbox) checkbox.checked = true;
            });
            showAlert('✓ All images selected', 'info');
        }

        function deselectAll() {
            images.forEach(img => {
                img.selected = false;
                const checkbox = document.getElementById(`select-${img.id}`);
                if (checkbox) checkbox.checked = false;
            });
            showAlert('✗ All images deselected', 'info');
        }

        function updateImageCard(imageData) {
            const statusEl = document.getElementById(`status-${imageData.id}`);
            if (statusEl) {
                statusEl.className = `image-card-status status-${imageData.status}`;
                statusEl.textContent = imageData.status === 'cleaned' ? '✓ Cleaned' : 
                                     imageData.status === 'processing' ? '⏳ Processing...' : '📋 Original';
            }
        }

        async function cleanSingleImage(id) {
            const imageData = images.find(img => img.id === id);
            if (!imageData) return;

            imageData.status = 'processing';
            updateImageCard(imageData);

            // Get current settings
            const settings = {
                author: authorInput.value.trim(),
                copyright: copyrightInput.value.trim(),
                title: titleInput.value.trim(),
                keywords: keywordsInput.value.trim(),
                description: descriptionInput.value.trim(),
                credit: creditInput.value.trim(),
                quality: parseInt(qualitySlider.value),
                resize: resizeEnabled.checked,
                resizeMode: resizeMode.value,
                resizeValue: parseInt(resizeValue.value) || 100,
                rotation: parseInt(rotationSelect.value),
                filter: filterSelect.value,
                format: outputFormat.value === 'original' ? imageData.type.split('/')[1] : outputFormat.value
            };
            
            await processImage(imageData, settings);
            
            imageData.status = 'cleaned';
            updateImageCard(imageData);
            updateStats();
            
            showAlert(`✅ Image "${imageData.name}" processed successfully!`, 'success');
        }

        async function cleanAllImages() {
            const selectedImages = images.filter(img => img.selected);
            if (selectedImages.length === 0) {
                showAlert('⚠️ No images selected. Please select images to process.', 'warning');
                return;
            }

            progressBar.style.display = 'block';
            cleanAllBtn.disabled = true;
            topCleanAllBtn.disabled = true;
            cleanAllBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
            topCleanAllBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            const settings = {
                author: authorInput.value.trim(),
                copyright: copyrightInput.value.trim(),
                title: titleInput.value.trim(),
                keywords: keywordsInput.value.trim(),
                description: descriptionInput.value.trim(),
                credit: creditInput.value.trim(),
                quality: parseInt(qualitySlider.value),
                resize: resizeEnabled.checked,
                resizeMode: resizeMode.value,
                resizeValue: parseInt(resizeValue.value) || 100,
                rotation: parseInt(rotationSelect.value),
                filter: filterSelect.value,
                format: outputFormat.value
            };

            let processed = 0;
            const total = selectedImages.length;

            for (const imageData of selectedImages) {
                imageData.status = 'processing';
                updateImageCard(imageData);
                
                await processImage(imageData, settings);
                
                imageData.status = 'cleaned';
                updateImageCard(imageData);
                
                processed++;
                const progress = (processed / total) * 100;
                progressFill.style.width = `${progress}%`;
                
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            cleanAllBtn.disabled = false;
            topCleanAllBtn.disabled = false;
            cleanAllBtn.innerHTML = '🗑️ Clean All';
            topCleanAllBtn.innerHTML = '🗑️ Clean All';
            
            updateStats();
            showAlert(`✅ All ${total} selected image(s) processed successfully!`, 'success');
        }

        async function applySettingsToAll() {
            await cleanAllImages();
        }

        function resetAllImages() {
            if (!confirm('Are you sure you want to reset all images to their original state?')) {
                return;
            }

            images.forEach(img => {
                img.status = 'original';
                img.cleanedDataUrl = null;
                img.cleanedBlob = null;
                updateImageCard(img);
            });

            updateStats();
            showAlert('🔄 All images reset to original state', 'info');
        }

        function processImage(imageData, settings) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    // Apply resize
                    if (settings.resize) {
                        switch (settings.resizeMode) {
                            case 'percent':
                                width = Math.round(width * settings.resizeValue / 100);
                                height = Math.round(height * settings.resizeValue / 100);
                                break;
                            case 'width':
                                height = Math.round(height * settings.resizeValue / width);
                                width = settings.resizeValue;
                                break;
                            case 'height':
                                width = Math.round(width * settings.resizeValue / height);
                                height = settings.resizeValue;
                                break;
                            case 'max':
                                const maxDim = Math.max(width, height);
                                if (maxDim > settings.resizeValue) {
                                    const scale = settings.resizeValue / maxDim;
                                    width = Math.round(width * scale);
                                    height = Math.round(height * scale);
                                }
                                break;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    
                    // Handle rotation
                    if (settings.rotation === 90 || settings.rotation === 270) {
                        canvas.width = height;
                        canvas.height = width;
                    } else {
                        canvas.width = width;
                        canvas.height = height;
                    }

                    const ctx = canvas.getContext('2d');
                    
                    // Apply rotation
                    if (settings.rotation) {
                        ctx.translate(canvas.width / 2, canvas.height / 2);
                        ctx.rotate((settings.rotation * Math.PI) / 180);
                        ctx.translate(-width / 2, -height / 2);
                    }

                    // Draw image
                    ctx.drawImage(img, 0, 0, width, height);

                    // Apply filters
                    if (settings.filter !== 'none') {
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        switch (settings.filter) {
                            case 'grayscale':
                                for (let i = 0; i < data.length; i += 4) {
                                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                    data[i] = data[i + 1] = data[i + 2] = avg;
                                }
                                break;
                            case 'sepia':
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = data[i], g = data[i + 1], b = data[i + 2];
                                    data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                                    data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                                    data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                                }
                                break;
                            case 'invert':
                                for (let i = 0; i < data.length; i += 4) {
                                    data[i] = 255 - data[i];
                                    data[i + 1] = 255 - data[i + 1];
                                    data[i + 2] = 255 - data[i + 2];
                                }
                                break;
                            case 'brightness':
                                for (let i = 0; i < data.length; i += 4) {
                                    data[i] = Math.min(255, data[i] * 1.2);
                                    data[i + 1] = Math.min(255, data[i + 1] * 1.2);
                                    data[i + 2] = Math.min(255, data[i + 2] * 1.2);
                                }
                                break;
                            case 'contrast':
                                const factor = (259 * (128 + 255)) / (255 * (259 - 128));
                                for (let i = 0; i < data.length; i += 4) {
                                    data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));
                                    data[i + 1] = Math.min(255, Math.max(0, factor * (data[i + 1] - 128) + 128));
                                    data[i + 2] = Math.min(255, Math.max(0, factor * (data[i + 2] - 128) + 128));
                                }
                                break;
                        }

                        ctx.putImageData(imageData, 0, 0);
                    }

                    // Save metadata for reference
                    imageData.settings = settings;
                    if (settings.author) imageData.metadata['Author'] = settings.author;
                    if (settings.copyright) imageData.metadata['Copyright'] = settings.copyright;
                    if (settings.title) imageData.metadata['Title'] = settings.title;
                    if (settings.keywords) imageData.metadata['Keywords'] = settings.keywords;
                    if (settings.description) imageData.metadata['Description'] = settings.description;
                    if (settings.credit) imageData.metadata['Credit'] = settings.credit;

                    // Convert to blob
                    const format = settings.format === 'original' ? imageData.type.split('/')[1] : settings.format;
                    const mimeType = `image/${format}`;
                    const quality = settings.quality / 100;

                    canvas.toBlob(function(blob) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imageData.cleanedDataUrl = e.target.result;
                            imageData.cleanedBlob = blob;
                            resolve();
                        };
                        reader.readAsDataURL(blob);
                    }, mimeType, quality);
                };
                img.src = imageData.originalDataUrl;
            });
        }

        function downloadSingleImage(id) {
            const imageData = images.find(img => img.id === id);
            if (!imageData) return;

            if (!imageData.cleanedBlob) {
                showAlert('⚠️ Please process the image first!', 'warning');
                return;
            }

            const url = URL.createObjectURL(imageData.cleanedBlob);
            const a = document.createElement('a');
            a.href = url;
            
            const fileName = generateFilename(imageData);
            a.download = fileName;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`⬇️ "${fileName}" downloaded!`, 'success');
        }

        function generateFilename(imageData) {
            const pattern = filenamePattern.value || 'clean_{original}';
            const baseName = imageData.name.replace(/\.[^/.]+$/, "");
            const ext = imageData.settings?.format || 'png';
            const date = new Date().toISOString().split('T')[0];
            const index = imageData.id;

            let filename = pattern
                .replace('{original}', baseName)
                .replace('{author}', imageData.settings?.author || '')
                .replace('{date}', date)
                .replace('{index}', index);

            return `${filename}.${ext}`;
        }

        async function downloadAllImages() {
            const cleanedImages = images.filter(img => img.cleanedBlob && img.selected);
            
            if (cleanedImages.length === 0) {
                showAlert('⚠️ Please process at least one selected image first!', 'warning');
                return;
            }

            if (cleanedImages.length === 1) {
                downloadSingleImage(cleanedImages[0].id);
                return;
            }

            downloadAllBtn.disabled = true;
            topDownloadAllBtn.disabled = true;
            downloadAllBtn.innerHTML = '<span class="loading-spinner"></span> Creating ZIP...';
            topDownloadAllBtn.innerHTML = '<span class="loading-spinner"></span> Creating ZIP...';
            
            const zip = new JSZip();
            const folder = zip.folder('cleaned_images');

            // Add images
            cleanedImages.forEach(imageData => {
                const fileName = generateFilename(imageData);
                folder.file(fileName, imageData.cleanedBlob);
            });

            // Add metadata CSV if enabled
            if (document.getElementById('exportMetadataFile').checked) {
                let csv = 'Filename,Original Size,Processed Size,Dimensions,Author,Title,Keywords\n';
                cleanedImages.forEach(imageData => {
                    const fileName = generateFilename(imageData);
                    csv += `"${fileName}","${formatBytes(imageData.size)}","${formatBytes(imageData.cleanedBlob.size)}",` +
                           `"${imageData.width}x${imageData.height}","${imageData.settings?.author || ''}",` +
                           `"${imageData.settings?.title || ''}","${imageData.settings?.keywords || ''}"\n`;
                });
                folder.file('metadata_report.csv', csv);
            }

            // Add README if enabled
            if (document.getElementById('exportReadme').checked) {
                const readme = generateReadme(cleanedImages);
                folder.file('README.txt', readme);
            }

            zip.generateAsync({ type: 'blob' }).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cleaned_images_${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                downloadAllBtn.disabled = false;
                topDownloadAllBtn.disabled = false;
                downloadAllBtn.innerHTML = '⬇️ Download All (ZIP)';
                topDownloadAllBtn.innerHTML = '⬇️ Download All as ZIP';
                
                showAlert(`⬇️ ZIP file with ${cleanedImages.length} processed images downloaded!`, 'success');
            });
        }

        function generateReadme(images) {
            const settings = images[0]?.settings || {};
            return `Processed Images - Metadata Report
=====================================

Total images: ${images.length}
Processed on: ${new Date().toLocaleString()}

Settings Applied:
-----------------
${settings.author ? `Author: ${settings.author}` : 'Author: Not specified'}
${settings.copyright ? `Copyright: ${settings.copyright}` : ''}
${settings.title ? `Title Template: ${settings.title}` : ''}
${settings.keywords ? `Keywords: ${settings.keywords}` : ''}
Quality: ${settings.quality}%
Format: ${settings.format}
${settings.resize ? `Resize: ${settings.resizeMode} - ${settings.resizeValue}` : 'Resize: Disabled'}
${settings.rotation ? `Rotation: ${settings.rotation}°` : ''}
${settings.filter !== 'none' ? `Filter: ${settings.filter}` : ''}

Metadata Status:
----------------
All original metadata has been removed.
${settings.author || settings.copyright || settings.title ? 'New metadata fields added as specified above.' : 'Images are completely clean with zero metadata.'}

Files Included:
---------------
${images.map((img, i) => `${i + 1}. ${generateFilename(img)} (${formatBytes(img.cleanedBlob.size)})`).join('\n')}

---
Generated by Advanced Image Metadata Cleaner
`;
        }

        function viewMetadata(id) {
            const imageData = images.find(img => img.id === id);
            if (!imageData) return;

            const modal = document.getElementById('metadataModal');
            const content = document.getElementById('modalMetadataContent');

            let html = '<h3>Original Metadata</h3>';
            html += '<div class="metadata-display">';
            
            if (Object.keys(imageData.metadata).length === 0) {
                html += '<div class="no-metadata">No metadata found</div>';
            } else {
                for (const [key, value] of Object.entries(imageData.metadata)) {
                    html += `
                        <div class="metadata-item">
                            <span class="metadata-key">${key}</span>
                            <span class="metadata-value">${value}</span>
                        </div>
                    `;
                }
            }
            
            html += '</div>';

            if (imageData.cleanedBlob) {
                html += '<h3 style="margin-top: 20px;">Applied Settings</h3>';
                html += '<div class="metadata-display">';
                const settings = imageData.settings;
                
                if (settings.author) html += `<div class="metadata-item"><span class="metadata-key">Author</span><span class="metadata-value">${settings.author}</span></div>`;
                if (settings.copyright) html += `<div class="metadata-item"><span class="metadata-key">Copyright</span><span class="metadata-value">${settings.copyright}</span></div>`;
                if (settings.title) html += `<div class="metadata-item"><span class="metadata-key">Title</span><span class="metadata-value">${settings.title}</span></div>`;
                if (settings.keywords) html += `<div class="metadata-item"><span class="metadata-key">Keywords</span><span class="metadata-value">${settings.keywords}</span></div>`;
                if (settings.description) html += `<div class="metadata-item"><span class="metadata-key">Description</span><span class="metadata-value">${settings.description}</span></div>`;
                
                html += `<div class="metadata-item"><span class="metadata-key">Quality</span><span class="metadata-value">${settings.quality}%</span></div>`;
                html += `<div class="metadata-item"><span class="metadata-key">Format</span><span class="metadata-value">${settings.format.toUpperCase()}</span></div>`;
                html += `<div class="metadata-item"><span class="metadata-key">File Size</span><span class="metadata-value">${formatBytes(imageData.cleanedBlob.size)}</span></div>`;
                
                html += '</div>';
            }

            content.innerHTML = html;
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('metadataModal').classList.remove('show');
        }

        function compareImage(id) {
            const imageData = images.find(img => img.id === id);
            if (!imageData) return;

            const modal = document.getElementById('comparisonModal');
            const content = document.getElementById('comparisonContent');

            const originalSize = formatBytes(imageData.size);
            const cleanedSize = imageData.cleanedBlob ? formatBytes(imageData.cleanedBlob.size) : 'N/A';
            const sizeDiff = imageData.cleanedBlob ? 
                formatBytes(imageData.size - imageData.cleanedBlob.size) : 'N/A';

            content.innerHTML = `
                <div class="comparison-side">
                    <h3>Original</h3>
                    <img src="${imageData.originalDataUrl}" alt="Original">
                    <p style="margin-top: 10px; color: #666;">
                        Size: ${originalSize}<br>
                        Metadata: ${Object.keys(imageData.metadata).length} fields
                    </p>
                </div>
                <div class="comparison-side">
                    <h3>Processed</h3>
                    ${imageData.cleanedDataUrl ? 
                        `<img src="${imageData.cleanedDataUrl}" alt="Processed">
                         <p style="margin-top: 10px; color: #666;">
                            Size: ${cleanedSize}<br>
                            Saved: ${sizeDiff}<br>
                            ${imageData.settings?.author ? `Author: ${imageData.settings.author}` : 'No metadata'}
                         </p>` :
                        '<p style="color: #999; margin-top: 50px;">Not yet processed</p>'
                    }
                </div>
            `;

            modal.classList.add('show');
        }

        function closeComparisonModal() {
            document.getElementById('comparisonModal').classList.remove('show');
        }

        function updateStats() {
            const total = images.length;
            const cleaned = images.filter(img => img.status === 'cleaned').length;
            const totalBytes = images.reduce((sum, img) => sum + img.size, 0);
            const savedBytes = images.reduce((sum, img) => {
                if (img.cleanedBlob) {
                    return sum + (img.size - img.cleanedBlob.size);
                }
                return sum;
            }, 0);

            // Update both stat sections
            totalImagesEl.textContent = total;
            cleanedImagesEl.textContent = cleaned;
            totalSizeEl.textContent = formatBytes(totalBytes);
            savedSizeEl.textContent = formatBytes(savedBytes);

            topTotalImagesEl.textContent = total;
            topCleanedImagesEl.textContent = cleaned;
            topTotalSizeEl.textContent = formatBytes(totalBytes);
        }

        function showAlert(message, type) {
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>
